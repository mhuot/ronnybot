const opennms = require('opennms/dist/opennms.node');
const SparkWebSocket = require('ciscospark-websocket-events');
const Botkit = require('botkit');
const fs = require('fs');

botConfig = JSON.parse(fs.readFileSync('./bot-config.json', 'utf-8'));

const accessToken = process.env.SPARK_TOKEN;
if (!accessToken) {
  console.log("No Cisco Spark access token found in env variable SPARK_TOKEN");
  process.exit(2);
}

const onmsurl = process.env.OpenNMS_URL || botConfig.OpenNMS_URL;
const onmsuser = process.env.OpenNMS_User || botConfig.OpenNMS_User;
const onmspw = process.env.OpenNMS_PW || botConfig.OpenNMS_PW;
const PORT = process.env.PORT || 3001;
const domain = process.env.SPARK_DOMAIN || botConfig.SPARK_DOMAIN;
const botadmin = process.env.botadmin || botConfig.botadmin;
if (domain) { domain.push('sparkbot.io'); } //workaround for issue with the spark botkit middle ware not excluding the messages from the bot

console.log(onmsurl);

// Spark Websocket Intialization
const sparkwebsocket = new SparkWebSocket(accessToken);
sparkwebsocket.connect(function (err, res) {
  if (!err) {
    sparkwebsocket.setWebHookURL("http://localhost:" + PORT + "/ciscospark/receive");
  } else {
    console.log("Error starting up websocket: " + err);
  }
})

//////// OpenNMS //////

const Client = opennms.Client;
const Comparators = opennms.API.Comparators;
const Filter = opennms.API.Filter;
const Restriction = opennms.API.Restriction;

const connection = async() => new Client().connect('Home', onmsurl, onmsuser, onmspw);

async function getAlarms () {
  try {
    const client = await connection();
    const filter = new Filter().withOrRestriction(new Restriction('id', Comparators.GE, 1));
    // query all alarms with an ID greater than or equal to 1
    return await client.alarms().find(filter);
  } catch (err) {
    console.error(err);
  }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
}

async function ackAlarm (id, user) {
  try {
    const client = await connection();
    return client.alarms().acknowledge(id, `onmsbot-${user}`).then(() => {
      console.log('Success!');
      return true;
    });
  } catch (err) {
    console.error(err);
  }
}

async function createAlarmAction (name, id, user) {
  try {
    const client = await connection();
    return await client.alarms()[name](id, `onmsbot-${user}`).then(() => {
      console.log('Success!');
      return true;
    });
  } catch (err) {
      return handleError(name + ' failed', err);
  }
}

//////// Bot Kit //////

const controller = 
  domain ? 
    Botkit.sparkbot({debug: true, log: true, public_address: "https://localhost", ciscospark_access_token: accessToken, limit_to_domain: domain })  
    : Botkit.sparkbot({debug: true, log: true, public_address: "https://localhost", ciscospark_access_token: accessToken });


const bot = controller.spawn({
});

controller.setupWebserver(PORT, function (err, webserver) {
  //setup incoming webhook handler
  webserver.post('/ciscospark/receive', function (req, res) {
      res.sendStatus(200)
      controller.handleWebhookPayload(req, res, bot);
  });
});


//
// Bot custom logic
//

controller.hears(['hi', 'hello'], 'direct_message,direct_mention', function (bot, message) {
  if (message.user == botadmin) {
    bot.reply(message, 'Hello great one!');
  } else {
    bot.reply(message, `Hello ${message.user}`);
  }
});

controller.hears('help', 'direct_message,direct_mention', function(bot, message){
  bot.startConversation(message, (errno, convo) => {
    convo.say('I currently support the following commands -');
    convo.say('show alarms [options]');
    convo.say('ack alarm <id>');
    convo.say('shutdown [options]');
    convo.say
  });
}); 

controller.hears(['^settings$', '^show settings$'], 'direct_message', function(bot, message) { 
  const settings = [`OpenNMS_URL is set for ${onmsurl}`, `OpenNMS user is set for ${onmsuser}` ];
  domain ? settings.push(`Spark limit_to_domain is set to ${domain.join(', ')}`) : settings.push('Spark limit_to_domain is not set')
  bot.startConversation(message, (errno, convo) => {
    convo.say(settings.join('<br>'));
    convo.next();
  });
});

controller.hears(['go away', 'good bye', 'bye', '^shutdown$'],'direct_message',function(bot, message) {
  bot.startConversation(message,function(err, convo) {
    convo.ask('Are you sure you want me to shutdown?',[
      {
        pattern: bot.utterances.yes,
        callback: function(response, convo) {
          convo.say('Bye!');
          convo.next();
          setTimeout(function() {
            process.exit();
          },3000);
        }
      },{
        pattern: bot.utterances.no,
        default: true,
        callback: function(response, convo) {
          convo.say('*Phew!*');
          convo.next();
        }
      }
    ]);
  });
});

controller.hears(['^shutdown -h now$'],'direct_message',function(bot, message) {
  bot.startConversation(message,function(err, convo) {
    convo.say('Bye!');
    convo.next();
    setTimeout(function() {
      process.exit();
    },3000);
  });
});

// controller.on('direct_mention', function (bot, message) {
//   bot.reply(message, 'You mentioned me and said, "' + message.text + '"');
// });

// controller.on('direct_message', function (bot, message) {
//   bot.reply(message, 'I got your private message. You said, "' + message.text + '"');
// });

controller.hears('^ack alarm ([0-9]+)$', 'direct_message,direct_mention', function (bot, message) {
  bot.startConversation(message, (errno, convo) => {
    ackAlarm(parseInt(message.match[1], 10),message.user).then( convo.say(`OK, I will ack alarm ID ${message.match[1]}`) );
    convo.next();
  });
});

controller.hears('^ack alarm$', 'direct_message,direct_mention', function (bot, message) {
  bot.startConversation(message, (errno, convo) => {
    convo.addQuestion('Which one?',function(response,convo) {
      ackAlarm(parseInt(response.text, 10),message.user).then( convo.say(`OK, I will ack alarm ID ${response.text}`));
      convo.next();
    },{},'default');
  });
});

controller.hears('^alarm ([a-zA-Z]+) ([0-9]+)$', 'direct_message,direct_mention', function(bot, message) {
  const id = message.match[2];
  const action = (() => {
    switch(message.match[1]) {
      case "unack":
        return "unacknowledge";
        break;
      case "create":
        return "createTicket";
        break;
      case "update":
        return "triggerTicketUpdate";
        break;
      case "close":
        return "closetTicket";
        break;
      case "deleteSticky":
        return "deleteStickyMemo";
        break;
      case "deleteJournal":
        return "deleteStickyMemo";
        break;
      default:
        return message.match[1];
    }
  })();
  console.log(`I will send a ${action} for alarm ID ${id}`);
  createAlarmAction(action, parseInt(id,10), message.user).then(resp => {
    bot.startConversation(message, (errno, convo) => {
      convo.say(`I will send a ${action} for alarm ID ${id}.`);
      convo.stop();
    });
  }).catch( err => {throw err;});
});

controller.hears(['show alarms count', 'alarms count'], 'direct_message,direct_mention', function (bot, message) {
  getAlarms().then(alarms => {
    bot.startConversation(message, (errno, convo) => {
      convo.say(`Number of alarms ${alarms.length}`);
      convo.next();
    });
  });
});

controller.hears(['^show alarms$', '^alarms$', '^alarms all$'], 'direct_message,direct_mention', function (bot, message) {
  bot.reply(message, 'Let me get the alarms for you...')
  getAlarms().then(alarms => {
    const length = alarms.length;
    const limit = 10;
    bot.startConversation(message, (errno, convo) => {
      convo.say(`Number of alarms ${length}`);
      if((length > 0 && length <= limit) || message.text === 'alarms all') {
        convo.say('Here are the alarms - ');
        sayAlarms(convo, alarms, length);
      } else if (length > limit) {
        bot.startConversation(message, (errno, convo) => {
          convo.ask(`There are more than ${limit} alarms, should I just show the most recent ${limit}?`,[
            {
              pattern: bot.utterances.yes,
              callback: function(response, convo) {
                sayAlarms(convo, alarms, limit);
                convo.next();
              }
            },{
              pattern: bot.utterances.no,
              default: true,
              callback: function(response, convo) {
                convo.say('I have not been told how to respond');
                convo.next();
              }
            }
          ]);
        }); 
      } else {
        msg.reply('Something went wrong.');
      }
    });
  });
});

async function sayAlarms (convo, alarms, limit) {
  const alarmMarkdown = [];
  const alarmText = [];
  for ( var i=0; i < limit; i++) {
    const desc = alarms[i].description.replace(/(<(?:.|\n)*?>)|\n/gm, '').replace(/\s\s+/g, ' ');
    alarmText.push(`Alarm ID - ${alarms[i].id.toString()}\nAlarm descrption - ${desc}\n`);
    alarmMarkdown.push(`Alarm ID - ${alarms[i].id.toString()}<br>Alarm description - ${desc} <hr>`);
  }
  console.log(`Text - ${alarmText.join('')}`);
  console.log(`Markdown - ${alarmMarkdown.join('')}`);
  convo.say({text: alarmText.join(''), markdown: alarmMarkdown.join('')});  
}

